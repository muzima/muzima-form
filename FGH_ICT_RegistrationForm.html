<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/muzima.css" rel="stylesheet">
    <link href="css/bootstrap-datetimepicker.min.css" rel="stylesheet">
    <link href="css/ui-darkness/jquery-ui-1.10.4.custom.min.css" rel="stylesheet">

    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-ui-1.10.4.custom.min.js"></script>
    <script src="js/jquery.validate.min.js"></script>
    <script src="js/additional-methods.min.js"></script>
    <script src="js/bootstrap-datetimepicker.min.js"></script>
    <script src="js/muzima.js"></script>

    <title>Actualizar Dados Pessoais</title>
</head>
<body class="col-md-8 col-md-offset-2">

<div id="result"></div>
<div id="pre_populate_data">
</div>
<form id="demographics_update_form" name="demographics_update_form">
    <h2 class="text-center">Actualizar Dados Pessoais</h2>

    <div class="section">
        <h3>Nome do Paciente</h3>
        <div class="form-group">
            <input class="form-control" id="patient.uuid"
                   name="patient.uuid" type="hidden" readonly="readonly" value="">
        </div>
        <div class="form-group">
            <label for="patient.family_name">Apelido: <span class="required">*</span> </label>
            <input class="form-control" id="patient.family_name" name="patient.family_name" type="text"
                   required="required">
        </div>
        <div class="form-group">
            <label for="patient.given_name">Nome: <span class="required">*</span></label>
            <input class="form-control" id="patient.given_name" name="patient.given_name" type="text"
                   required="required">
        </div>
        <div class="form-group">
            <label for="patient.middle_name">Nome do meio:</label>
            <input class="form-control" id="patient.middle_name" name="patient.middle_name" type="text">
        </div>
    </div>
    <div class="section">
        <div class="section group-set" data-group="patient.personaddress">
            <h3>Endereço</h3>
            <div class="form-group">
                <label for="address1">Avenida/Rua: </label>
                <input class="form-control" id="address1" name="address1" type="text">
            </div>
            <div class="form-group">
                <label for="address2">Casa Nº: </label>
                <input class="form-control" id="address2" name="address2" type="text">
            </div>
            <div class="form-group">
                <label for="address6">Unidade Comunal: </label>
                <input class="form-control" id="address6" name="address6" type="text">
            </div>
            <div class="form-group">
                <label for="address3">Quarteirão: </label>
                <input class="form-control" id="address3" name="address3" type="text">
            </div>
            <div class="form-group">
                <label for="address5">Bairro: </label>
                <input class="form-control" id="address5" name="address5" type="text">
            </div>
        </div>
        <div class="group-set" data-group="patient.personattribute">
            <div class="form-group">
                <label for="attribute_value">Novo Contacto do Paciente: </label>
                <input class="form-control" id="attribute_value"
                       name="attribute_value" type="text">
                <input data-metadata-for="attribute_value" type="hidden" id="attribute_type_uuid"
                       name="attribute_type_uuid" value="e2e3fd64-1d5f-11e0-b929-000c29ad1d07">
            </div>
        </div>
    </div>

    <div class="section">
        <h3>Identificadores</h3>
        <div class="form-group">
            <label for="patient.medical_record_number">NID : <span class="required require_medical_record_number_hint">*</span></label>

            <div class="form-horizontal">
                <div class="group-set" data-group="patient.medical_record_number">
                    <input type="button" class='btn barcode_btn form-control'>
                    <input class="barcode_text form-control valid_NID" id="identifier_value"
                           name="identifier_value" type="text" required="required">
                    <input data-metadata-for="identifier_value" type="hidden" id="identifier_type_uuid"
                           name="identifier_type_uuid" value="e2b966d0-1d5f-11e0-b929-000c29ad1d07">
                </div>
            </div>
        </div>
    </div>
    <div class="section">
        <div class="form-group">
            <label for="patient.sex">Sexo: <span class="required">*</span></label>
            <select class="form-control" id="patient.sex" name="patient.sex">
                <option value="">...</option>
                <option value="M">Male</option>
                <option value="F">Female</option>
            </select>
        </div>

        <div class="form-group">
            <label for="tmp.birthdate_type">Registrará a data de nascimento... <span class="required">*</span></label>
            <select class="form-control" name="tmp.birthdate_type" id="tmp.birthdate_type" required="required">
                <option value="">...</option>
                <option value="birthdate">Por data de nascimento</option>
                <option value="age">Por idade</option>
            </select>
        </div>
        <div class="form-group show_birthdate">
            <label for="patient.birth_date">Selecione Nova Data de Nascimento<span class="required">*</span></label>
            <input class="form-control birth_date_picker nonFutureDate" id="patient.birth_date"
                   name="patient.birth_date"
                   type="text"
                   required="required">
        </div>
        <div class="form-group show_birthdate">
            <label for="patient.birthdate_estimated">Esta data de nascimento é uma estimativa? <span
                    class="required">*</span></label>
            <select class="form-control" id="patient.birthdate_estimated" name="patient.birthdate_estimated"
                    required="required">
                <option value="">...</option>
                <option value="true">Sim</option>
                <option value="false">Nao</option>
            </select>
        </div>
        <div class="form-group show_age">
            <label for="tmp.age_in_years">Quantos anos você tem em anos?<span class="required">*</span></label>
            <input class="form-control" id="tmp.age_in_years" name="tmp.age_in_years" type="number" required="required">

        </div>
    </div>


    <div class="section">
        <h3>TESTE DO CASO DO INDICE DO PACIENTE</h3>
        <div class="form-group">
            <label for="obs.index_patient_source">Origem CI:<span class="required">*</span></label>
            <select class="form-control" id="obs.index_patient_source" required
                    name="obs.contact_testing_consent" data-concept="23877^Origem CI^99DCT">
                <option value="">...</option>
                <option value="1597^UATS^99DCT">UATS</option>
                <option value="5271^CPF^99DCT">CPF</option>
                <option value="23876^Enf. Cirurgia^99DCT">Enf. Cirurgia</option>
                <option value="23875^Enf. Medicina^99DCT">Enf. Medicina</option>
                <option value="23874^Enf. Pediatria^99DCT">Enf. Pediatria</option>
                <option value="23873^Triagem Adulto^99DCT">Triagem Adulto</option>
                <option value="23872^Triagem Banco Socorro^99DCT">Triagem Banco Socorro</option>
                <option value="23871^Banco Socorro^99DCT">Banco Socorro</option>
                <option value="1926^Banco de Sangue^99DCT">Banco de Sangue</option>
                <option value="23868^Estomatologia^99DCT">Estomatologia</option>
                <option value="6303^VBG^99DCT">VBG</option>
                <option value="23870^Gabinete Médico^99DCT">Gabinete Médico</option>
                <option value="1596^Consulta Externa^99DCT">Consulta Externa</option>
                <option value="1987^SAAJ^99DCT">SAAJ</option>
                <option value="23878^CPP^99DCT">CPP</option>
                <option value="1978^CPN^99DCT">CPN</option>
                <option value="1872^CCR^99DCT">CCR</option>
                <option value="1414^PNCTL^99DCT">PNCTL</option>
                <option value="23869^Maternidade^99DCT">Maternidade</option>
                <option value="6423^CCS^99DCT">CCS</option>
                <option value="6142^APSS-PP^99DCT">APSS-PP</option>
            </select>
        </div>
        <div class="form-group">
            <label for="obs.contact_testing_consent">Paciente consente testagem dos contactos:
                <span class="required">*</span></label>
            <select class="form-control" id="obs.contact_testing_consent" required
                    name="obs.contact_testing_consent" data-concept="21155^Paciente consente testagem dos contactos^99DCT">
                <option value="">...</option>
                <option value="21154^HEALTH FACILITY^99DCT">Unidade Sanitária</option>
                <option value="6403^Comunidade^99DCT">Comunidade</option>
                <option value="1066^Recusa^99DCT">Recusa</option>
            </select>
        </div>
        <div class="form-group">
            <label for="obs.expected_testing_date">Data Prevista para Testagem:
                <span class="required">*</span></label>
            <input class="form-control datepicker nonPostEncounterDate" readonly="readonly"
                   id="obs.expected_testing_date" data-concept="23879^Data Prevista para Testagem^99DCT"
                   name="obs.expected_testing_date" type="text" required="required">
        </div>
<!--        <div class="form-group">-->
<!--            <label for="obs.contact_phoning_consent">Patient consents to Contacts being phoned by-->
<!--                health personnel:<span class="required">*</span></label>-->
<!--            <select class="form-control" id="obs.contact_phoning_consent" required-->
<!--                    name="obs.contact_phoning_consent" data-concept="ddd^Contact phoning consent^99DCT">-->
<!--                <option value="">...</option>-->
<!--                <option value="1065^Sim^99DCT">Sim</option>-->
<!--                <option value="1066^Nao^99DCT">Nao</option>-->
<!--            </select>-->
<!--        </div>-->
    </div>

    <div class="section">
        <h3>FICHA RESUMO/Situação da família</h3>

        <div style="background-color:#f0ffff;" class="section group-set repeat person_relationships" data-group="person.relationships" data-name="person.relationships"
             id="person_relationships">
            <h3>Contact person</h3>
            <div class="form-group">
                <label>Relationship to person: <span class="required"></span></label>
                <select class="form-control person.relationshipType" name="person.relationshipType">
                    <option value="">...</option>
                </select>
                <input type="hidden" name="tmp.relationshipType" class="tmp.relationshipType" />
            </div>
            <div class="form-group search_person">
                <label>Nome do familiar:<span class="required">*</span></label>
                <input required="required" class="form-control tmp.person_name_search" type="text"
                       placeholder="Search locally on device...">
                <input class="form-control personA.uuid" name="personA.uuid" type="hidden" value="">
                <input class="form-control personB.uuid" name="personB.uuid" type="hidden" value="">
                <input class="form-control tmp.person_name_search_count" name="tmp.person_name_search_count" type="hidden" value="">
                <div class="no_results_msg_local alert alert-info" style="display:none">
                    Individual not found on this device. Please select <b><i>Search server</i></b> option to search this individual on the
                    server. You can also register them as a new person by selecting <b><i>Create Person</i></b> below.
                </div>
                <div class="no_results_msg_server alert alert-success" style="display:none">
                    Individual not found on the server. Please register them as a new contact person by selecting <b><i>Create Person</i></b> below.</div>
                <div><label><input type="checkbox" name="tmp.search_server" class="tmp.search_server">&nbsp;Search server</label></div>
            </div>
            <div class="person_details">
                <input class="tmp.person_uuid" name="tmp.person_uuid" type="hidden">
                <div class="form-group">
                    <label for="tmp.person_search_sex">Gender:</label>
                    <select class="form-control tmp.person_search_sex" id="tmp.person_search_sex" name="tmp.person_search_sex"
                            readonly="readonly" disabled="disabled">
                        <option value="">...</option>
                        <option value="M">Male</option>
                        <option value="F">Female</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tmp.person_search_birth_date">Date Of Birth:</label>
                    <input class="form-control tmp.person_search_birth_date tmp.person_search_birth_date" name="tmp.person_search_birth_date" type="text" readonly="readonly"
                           disabled="disabled">
                </div>
                <div class="form-group">
                    <label for="tmp.contact_age">Idade:</label>
                    <input class="form-control tmp.contact_age"
                           name="tmp.contact_age" type="number" readonly="readonly">
                </div>
                <div class="form-group">
                    <label for="tmp.hiv_test">Teste de HIV:</label>
                    <input class="form-control tmp.hiv_test"
                           name="tmp.hiv_test" readonly="readonly" />
                </div>
                <div class="form-group">
                    <label for="tmp.hiv_care">Cuidados de HIV:</label>
                    <input class="form-control tmp.hiv_care" readonly="readonly"
                           name="tmp.hiv_care" />
                </div>
                <div class="form-group">
                    <label for="tmp.child_at_risk_treatment">EM CCR:</label>
                    <input class="form-control tmp.child_at_risk_treatment" readonly="readonly"
                           name="tmp.child_at_risk_treatment" />
                </div>
                <div class="form-group">
                    <label for="tmp.relative_nid">NID:</label>
                    <input class="form-control tmp.relative_nid"
                           name="tmp.relative_nid" type="number" readonly="readonly">
                </div>
                <div class="form-group">
                    <label class="update-relationship-person" data-result-field="">
                        <input class="tmp.update_person_details" data-result-field=""
                               data-personUuid="" name="tmp.update_person_details" type="checkbox">
                        Atualizar situacao familiar conjunta?
                    </label>
                </div>
            </div>
            <div class="form-group create_person">
                OR <br />
                <button onclick="return false" class="form-control btn btn-primary create-relationship-person"
                        data-result-field="">Create person</button>
            </div>
        </div>
    </div>

    <div class="section">
        <h3>Detalhes do encontro</h3>
        <div class="form-group">
            <label for="encounter.location_id">Unidade Sanitaria:<span class="required">*</span></label>
            <input class="form-control valid-location-only" id="encounter.location_id" type="text"
                   placeholder="Start typing something..." required="required" >
            <input class="form-control" name="encounter.location_id" type="hidden">
        </div>

        <div class="form-group hidden">
            <select class="form-control" id="encounter.location_id_select" required="required">
                <option>...</option>
            </select>
        </div>
        <div class="form-group">
            <label for="encounter.provider_id_select">Consenheiro:</label>
            <input class="form-control valid-provider-only" id="encounter.provider_id_select" type="text"
                   placeholder="Start typing something..." >
            <input class="form-control" name="encounter.provider_id_select" type="hidden">
        </div>
        <div class="form-group show_provider_id_text">
            <label for="encounter.provider_id">ID do sistema do provedor:<span class="required">*</span></label>
            <input class="form-control checkDigit" id="encounter.provider_id" name="encounter.provider_id"
                   type="text" required="required" disabled="disabled">
        </div>
        <div class="form-group">
            <label for="encounter.encounter_datetime">Encontro<span class="required">*</span></label>
            <input class="form-control datetimepicker nonFutureDate past-date" id="encounter.encounter_datetime"
                   name="encounter.encounter_datetime"
                   type="text" required="required">
        </div>
        <div class="form-group">
            <input class="form-control" id="encounter.form_uuid" name="encounter.form_uuid" type="hidden" required="required">
        </div>
    </div>
</form>

</body>
<script type="text/javascript">
    $(document).ready(function () {
        var dateFormat = "dd-mm-yy";
        var currentDate = $.datepicker.formatDate(dateFormat, new Date());
        var encounterDatetime = $('#encounter\\.encounter_datetime');
        if ($(encounterDatetime).val() == "") {
            $(encounterDatetime).val(currentDate);
        }

        var currentYear = new Date().getFullYear();
        var birthdate_start_year = currentYear - 140;
        $('.birth_date_picker').datepicker({
            dateFormat: dateFormat,
            changeMonth: true,
            changeYear: true,
            yearRange: birthdate_start_year + ':' + currentYear,
        });

        $('.birth_date_picker').change(function () {
            $(this).valid();
        });


        $('#save_draft').click(function () {
            // pre process the medications
            $(this).prop('disabled', true);
            document.saveDraft(this);
            $(this).prop('disabled', false);
        });

        $('#submit_form').click(function () {
            // pre process the medications
            $(this).prop('disabled', true);
            document.submit();
            $(this).prop('disabled', false);
        });

        $('#tmp\\.update_names').change(function(){
            if($(this).is(':checked')){
                $('#update_names').show();
            } else {
                $('#update_names').hide();
            }
        });
        $('#tmp\\.update_names').trigger('change');

        $('#tmp\\.update_address').change(function(){
            if($(this).is(':checked')){
                $('#update_address').show();
            } else {
                $('#update_address').hide();
            }
        });
        $('#tmp\\.update_address').trigger('change');

        $('#tmp\\.update_sex').change(function(){
            if($(this).is(':checked')){
                $('#update_sex').show();
            } else {
                $('#update_sex').hide();
            }
        });
        $('#tmp\\.update_sex').trigger('change');

        $('#tmp\\.update_birthdate').change(function(){
            if($(this).is(':checked')){
                $('#update_birthdate').show();
            } else {
                $('#update_birthdate').hide();
            }
        });
        $('#tmp\\.update_birthdate').trigger('change');

        $('#patient\\.sex').change(function(){
            if($(this).val() == 'M'){
                $('#tmp\\.patient\\.sex').val('Male');
            } else if ($(this).val() == 'F') {
                $('#tmp\\.patient\\.sex').val('Female');
            }
        });
        $('#patient\\.sex').trigger('change');

        $.fn.calculateFields = function () {
            var tempAgeInYears = $.trim($("#tmp\\.age_in_years").val());
            if (tempAgeInYears != '') {
                $('#patient\\.birthdate_estimated').val('true');
                $('#patient\\.birth_date').val($.fn.getTempBirthDate(tempAgeInYears));
            }
            return true;
        };

        $.fn.customValidationCheck = function () {
            return $.fn.calculateFields();
        };

        var dobType = $('#tmp\\.birthdate_type');
        dobType.change(function () {
            var $show_birth_date = $('.show_birthdate');
            var $show_age = $('.show_age');
            if ($('#tmp\\.birthdate_type').val() == 'age') {
                $show_age.show();
                $show_birth_date.find('input').val('');
                $show_birth_date.hide();
            } else {
                $show_age.hide();
                $show_age.find('input').val('');
                $show_birth_date.show();
            }
        });
        dobType.trigger('change');

        // var patient_data = JSON.parse($("#pre_populate_data").text());
        // var patient_payload = patient_data.patient;
        // $.each(patient_payload, function (key, value) {
        //     if (value instanceof Object) {
        //         if (value instanceof Array) {
        //             $.each(value, function (i, element) {
        //                 if(element.attribute_type_uuid=="e2e3fd64-1d5f-11e0-b929-000c29ad1d07"){
        //                     $("#patient\\.phone_number").val(element.attribute_value);
        //                 }
        //             });
        //         }
        //     }
        // });

        var requireMedicalRecordNumber =  htmlDataStore.isMedicalRecordNumberRequired();
        if(requireMedicalRecordNumber){
            $(".require_medical_record_number_hint").show();
            $("#identifier_value").attr("required","required");
        } else {
            $(".require_medical_record_number_hint").hide();
            $("#identifier_value").removeAttr("required","required");
        }

        var setUpPersonFieldsPopulation = function($parent, patientFieldSelector, relatedPersonFieldSelector, searchServer){
            var patientUuid = $('#patient\\.uuid').val();
            var patientFieldValue = $parent.find(patientFieldSelector).val();
            if(patientFieldValue != '' && patientFieldValue != patientUuid){
                $parent.find(relatedPersonFieldSelector).val($parent.find(patientFieldSelector).val());
            }

            $parent.find(patientFieldSelector).val(patientUuid);
            document.setupAutoCompleteForPerson(
                $parent.find('.tmp\\.person_name_search'),$parent.find(relatedPersonFieldSelector),
                $parent.find('.tmp\\.person_name_search_count'),searchServer
            );

            $parent.find('.tmp\\.person_name_search').change(function(){
                if($parent.find('.tmp\\.person_name_search').val() == ''){
                    $parent.find('.tmp\\.person_search_sex').val('');
                    $parent.find('.tmp\\.person_search_gender').val('');
                    $parent.find('.tmp\\.person_search_birth_date').val('');
                    $parent.find('.tmp\\.person_name_search').val('');
                    $parent.find('.person_details').hide();
                    $parent.find('.create_person').show();
                } else {
                }
            })
            $parent.find('.tmp\\.person_name_search').trigger('change');

            $parent.find('.tmp\\.person_name_search_count').change(function(){
                if($(this).val() == 0){
                    $parent.find('.create_person').show();
                    if(searchServer){
                        $parent.find('.no_results_msg_local').hide();
                        $parent.find('.no_results_msg_server').show();
                    } else {
                        $parent.find('.no_results_msg_server').hide();
                        $parent.find('.no_results_msg_local').show();
                    }
                } else {
                    $parent.find('.create_person').hide();
                    $parent.find('.no_results_msg_local').hide();
                    $parent.find('.no_results_msg_server').hide();
                }
            });
            //$parent.find('.tmp\\.person_name_search_count').trigger('change');

            $parent.find(relatedPersonFieldSelector).change(function(){
                $parent = $(this).closest('.group-set');
                var uuid = $(this).val();
                if(uuid != ''){

                    var personB;
                    if(searchServer){
                        personB = htmlDataStore.getPatientDetailsFromServerByUuid(uuid);
                    } else {
                        personB = htmlDataStore.getPersonDetailsFromDeviceByUuid(uuid);
                    }

                    personB = JSON.parse(personB);
                    if('uuid' in personB) {
                        $parent.find('.create-relationship-person').attr("data-personUuid",uuid);
                        $parent.find('.tmp\\.person_search_sex').val(personB.sex);
                        $parent.find('.tmp\\.person_search_gender').val(personB.gender);
                        $parent.find('.tmp\\.person_search_birth_date').val(personB.birth_date);
                        $parent.find('.tmp\\.person_name_search').val(personB.name);

                        var age = $.fn.getAgeInYears(personB.birth_date)
                        $parent.find('.tmp\\.contact_age').val(Math.round(age));

                        var patientUuid = uuid;
                        $parent.find('.tmp\\.person_uuid').val(patientUuid);

                        var hiv_test = htmlDataStore.getObsByConceptId(patientUuid, 23779);
                        hiv_test = JSON.parse(hiv_test);
                        if(hiv_test.length) {
                            hiv_test = hiv_test[hiv_test.length-1];
                            if (hiv_test.valueCoded.id == 703){
                                $parent.find('.tmp\\.hiv_test').val('Positivo');
                            } else if (hiv_test.valueCoded.id == 664){
                                $parent.find('.tmp\\.hiv_test').val('Negativo');
                            } else if (hiv_test.valueCoded.id == 1067){
                                $parent.find('.tmp\\.hiv_test').val('Desconhecido');
                            }
                        }

                        var hiv_care = htmlDataStore.getObsByConceptId(patientUuid, 23780);
                        hiv_care = JSON.parse(hiv_care);
                        if(hiv_care.length) {
                            hiv_care = hiv_care[hiv_care.length-1];
                            if (hiv_care.valueCoded.id == 1065){
                                $parent.find('.tmp\\.hiv_care').val('Sim');
                            } else if (hiv_care.valueCoded.id == 1066){
                                $parent.find('.tmp\\.hiv_care').val('Nao');
                            }
                        }

                        var child_at_risk_treatment = htmlDataStore.getObsByConceptId(patientUuid, 1885);
                        child_at_risk_treatment = JSON.parse(child_at_risk_treatment);
                        if(child_at_risk_treatment.length) {
                            child_at_risk_treatment = child_at_risk_treatment[child_at_risk_treatment.length-1];
                            if (child_at_risk_treatment.valueCoded.id == 1065){
                                $parent.find('.tmp\\.child_at_risk_treatment').val('Sim');
                            } else if (child_at_risk_treatment.valueCoded.id == 1066){
                                $parent.find('.tmp\\.child_at_risk_treatment').val('Nao');
                            } else if (child_at_risk_treatment.valueCoded.id == 23892){
                                $parent.find('.tmp\\.child_at_risk_treatment').val('Alta');
                            }
                        }

                        var relative_nid = htmlDataStore.getObsByConceptId(patientUuid, 23781);
                        relative_nid = JSON.parse(relative_nid);
                        if(relative_nid.length) {
                            relative_nid = relative_nid[relative_nid.length-1];
                            $parent.find('.tmp\\.relative_nid').val(relative_nid.valueText);
                        }
                    }

                    $parent.find('.person_details').show();
                    $parent.find('.create_person').hide();
                } else {
                    $parent.find('.tmp\\.person_search_sex').val('');
                    $parent.find('.tmp\\.person_search_gender').val('');
                    $parent.find('.tmp\\.person_search_birth_date').val('');
                    $parent.find('.tmp\\.person_name_search').val('');
                    $parent.find('.tmp\\.hiv_test').val('');
                    $parent.find('.tmp\\.hiv_care').val('');
                    $parent.find('.tmp\\.child_at_risk_treatment').val('');
                    $parent.find('.tmp\\.relative_nid').val('');

                    $parent.find('.person_details').hide();
                    $parent.find('.create_person').show();
                }

            });
            $parent.find(relatedPersonFieldSelector).trigger('change');
        }

        var relationshipTypes = htmlDataStore.getRelationshipTypesFromDevice();

        relationshipTypes = JSON.parse(relationshipTypes);
        $.each(relationshipTypes, function (key, relationship) {
            var o = new Option(relationship.AIsToB, relationship.uuid);
            $(o).html(relationship.AIsToB); /// jquerify the DOM object 'o' so we can use the html method
            $(o).addClass('AIsToB');
            $(".person\\.relationshipType").append(o);

            o = new Option(relationship.BIsToA, relationship.uuid);
            $(o).html(relationship.BIsToA);
            $(o).addClass('BIsToA');
            $(".person\\.relationshipType").append(o);
        });

        $.each($('.tmp\\.relationshipType'), function(key,value){
            var $parent = $(this).closest('.repeat');
            if($parent.find('.tmp\\.person_name_search') != ''){
                $parent.find('.person\\.relationshipType').val($(this).val());
                // var personUuid = $parent.find('.tmp\\.person_uuid')
                // $parent.find('.create-relationship-person').attr("data-personUuid",personUuid);
            }
        });

        $('.person\\.relationshipType').change(function(){
            var relationshipDirection = $(this).find(':selected').attr('class')
            var $parent = $(this).closest('.repeat');
            var searchServer = $parent.find('.tmp\\.search_server').is(':checked');

            if(relationshipDirection == 'AIsToB'){
                $parent.find('.tmp\\.relationshipType').val($(this).val());
                $parent.find('.create-relationship-person').attr('data-result-field','personB\\.uuid');
                $parent.find('.tmp\\.update_person_details').attr('data-result-field','personB\\.uuid');
                setUpPersonFieldsPopulation($parent,'.personA\\.uuid','.personB\\.uuid', searchServer);

                $parent.find('.search_person').show();
                $parent.find('.create_person').hide();

            } else if(relationshipDirection == 'BIsToA'){
                $parent.find('.tmp\\.relationshipType').val($(this).val());
                $parent.find('.create-relationship-person').attr('data-result-field','personA\\.uuid');
                $parent.find('.tmp\\.update_person_details').attr('data-result-field','personA\\.uuid');
                setUpPersonFieldsPopulation($parent,'.personB\\.uuid','.personA\\.uuid', searchServer);

                $parent.find('.search_person').show();
                $parent.find('.create_person').hide();
            } else {
                //$parent.find('.tmp\\.relationshipType').val('');
                $parent.find('.personA\\.uuid').val('');
                $parent.find('.personB\\.uuid').val('');
                $parent.find('.tmp\\.person_search_sex').val('');
                $parent.find('.tmp\\.person_search_gender').val('');
                $parent.find('.tmp\\.person_search_birth_date').val('');
                $parent.find('.tmp\\.person_name_search').val('');
                $parent.find('.search_person').hide();
                $parent.find('.create_person').hide();
                $parent.find('.person_details').hide();
            }
        });
        $('.person\\.relationshipType').trigger('change');

        $('.tmp\\.search_server').change(function(){
            var $parent = $(this).closest('.repeat');
            if($(this).is(':checked')) {
                $parent.find('.tmp\\.person_name_search').attr('placeholder','Search server...')
            } else {
                $parent.find('.tmp\\.person_name_search').attr('placeholder','Search locally on device...')
            }
            $parent.find('.no_results_msg_local').hide();
            $parent.find('.no_results_msg_server').hide();
            $parent.find('.create_person').hide();
            $parent.find('.person\\.relationshipType').trigger('change');
        });

        $('.tmp\\.update_person_details').change(function(){
            if($(this).is(':checked')) {
                var $parent = $(this).closest('.repeat');
                var resultField = $(this).attr('data-result-field');
                var personUuid = $parent.find('.tmp\\.person_uuid').val();
                document.updatePersonDemographics($parent.attr('data-name'),resultField,personUuid);
            }
        });

        $.validator.addMethod("valid_NID", function (value, element) {
                return value.match(/[0-9]{8}\/[0-9]{2}\/[0-9]{4}/) != null;
            }, "Please specify a valid NID in the format PPDDUUSS/AA/NNNN."
        );

        jQuery.validator.addClassRules({
            valid_NID: { valid_NID: true }
        });

        document.setupAutoCompleteData('encounter\\.location_id');

        document.setupAutoCompleteDataForProvider('encounter\\.provider_id_select');

        document.setupValidationForProvider("$('#encounter\\.provider_id_select').val()","encounter\\.provider_id");

        document.setupValidationForLocation("$('#encounter\\.location_id').val()","encounter\\.location_id");


        $('#demographics_update_form').validate();

    });
</script>
</html>
